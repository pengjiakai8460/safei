<?php
$this->_var['repaycss'][] = $this->_var['TMPL_REAL']."/css/datepicker.css";
$this->_var['repayjs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.ui.core.js";
$this->_var['repayjs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.ui.widget.js";
$this->_var['repayjs'][] = $this->_var['TMPL_REAL']."/js/utils/jquery.ui.datepicker.js";
?>
<link rel="stylesheet" type="text/css" href="{function name="parse_css" v="$repaycss"}" />
<script type="text/javascript" src="{function name="parse_script" v="$repayjs" c="$repayjs"}"></script>

<script type="text/javascript">
jQuery(function(){
	$("input#begin_time").datepicker({showAnim:'fadeIn'});
	$("input#end_time").datepicker({showAnim:'fadeIn'});
	$("input#buy_begin_time").datepicker({showAnim:'fadeIn'});
	$("input#buy_end_time").datepicker({showAnim:'fadeIn'});
	
	$("form#search-form").submit(function(){
		var val = $("input#begin_time").val();
		$("input[name='begin_time']").val(val.replace(/-/g,""));
		
		var val = $("input#end_time").val();
		$("input[name='end_time']").val(val.replace(/-/g,""));
		
		var val = $("input#buy_begin_time").val();
		$("input[name='buy_begin_time']").val(val.replace(/-/g,""));
		
		var val = $("input#buy_end_time").val();
		$("input[name='buy_end_time']").val(val.replace(/-/g,""));
		
	});	
	account_more_search("#more_search_btn","#more_search");
});
</script>
<!--中间 开始-->
<div class="tabbox clearfix">
	<div class="tab cur"><a href="{url x="index" r="licai#uc_redeem"}">赎回申请</a></div>
</div>
<div class="dlmain Myhomepage licai_uc bdd bt0 uc_box">
	<div class="homeright pageright f_l">
		<div class="list_content licai_uc_redeem">
        	<form class="ajax_form" >	
            <input type="hidden" name="id" value="{$vo.id}" />
			<div class="licai_uc_redeem_hd mt20">
				<div>
					<img src="{$TMPL}/images/licai/licai_img1.jpg" width="50" height="50" class="pl20 f_l mr10" />
					<div class="text">
						<span>理财宝资金受特别保护，安全可靠，请放心操作</span>
						<span class="f_999"><br />赎回申请通过后,您的本金和收益会转入会员余额帐户,可以申请提现！</span>
					</div>
				</div>
				<div class="blank10"></div>
			</div>
			<div class="licai_uc_redeem_bd">
				<div class="control-group">
					<label class="control_label small_control_label">持有金额:</label>
                    <div class="small_control_cont" >
                    	<span class="f_red" >{$vo.money_format}</span>（赎回申请中<span>{$vo.redempte_wait_pay_format}</span>，还可赎回<span id='have_money' title='{$vo.have_money}'>{$vo.have_money_format}</span>）
                    </div>
				</div>
				<div class="control-group">
					<label class="form_lable">申请赎回金额:</label>
					<input type="text" name="redeem_money" class="textbox" id="redeem_money" autocomplete="off" />
                    <div class="form_cont">元</div>
					<div class="blank5"></div>
					<span class="notes">预计收益金额<em class="f_red" id='redeem_interest_money' >:0元</em></span>
                    <span class='hide' id="back_rate">{$vo.back_rate}</span>
					<div class="blank0"></div>
				</div>
                <div class="control-group">
					<label class="control_label small_control_label">预计到账金额:</label>
					<div class="small_control_cont"><span class="f_red" id="expect_amount">0</span>元 </div>
                </div>
				<div class="control-group">
					<label class="form_lable">预计到账时间:</label>
					<div class="form_cont">预计<span class="f_red">{$vo.purchasing_time}</span>前到账，转出资金自转出申请之日起不产生收益!</div>
					<div class="blank0"></div>
				</div>
				<div class="control-group">
					<label class="form_lable">平台支付密码:</label>
					<input type="password" name="password" class="textbox" />
                    {if $user_info.paypassword}
                    <a href="{url x="index" r="settings#security"}" class="theme_fcolor">忘记密码？</a>
                    {else}
                    	还未设置，<a href='{url x="index" r="settings#security"  p="method=setting-pass-box"}' target="_blank" class="f_red">点击设置</a>。
                    {/if}
					<div class="blank0"></div>
				</div>
				<div class="submit_btn_row control-group">
					<label class="form_lable"></label>
					<input type="button" value="确认赎回" class="ui-button bg_red mr10" id="redeem_btn" />
					<a href="{url x="index" r="licai#uc_buyed_lc"}" class="ui_button bg_gray">返回</a>
					<div class="blank20"></div>
				</div>
				<div class="question_box">
					<div class="question_hd f14">使用遇到问题？</div>
					<div class="question_bd">
						<div class="question_item">
							<div class="q">
								<label>问：</label>
								<span>理财宝转出至银行卡到账时间</span>
							</div>
							<div class="a">
								<label>答：</label>
								<div class="text">
									按理财宝转出至银行卡的金额，会区分以下3种到账时间：<br />
                                    1、普通到账：提交后的下一个基金交易日内24点前到账。<br />
									2、实时到账：仅支持中信、光大、平安、招行卡通。<br />
									3、2小时到账：仅支持无线，日累计5万以内（含），且在该卡服务时间内。具体到账时间点此查看<br />
								</div>
							</div>
						</div>
						<div class="question_item">
							<div class="q">
								<label>问：</label>
								<span>理财宝转出至银行卡有次数和额度限制吗？</span>
							</div>
							<div class="a">
								<label>答：</label>
								<div class="text">
									一个账户一天最多可操作3次转出至银行卡，具体限额以页面显示为准，以下限额仅供参考： <br />
                                    1、普通提现银行卡：单日/单笔5万、单月无限额； <br />
                                    2、储蓄卡快捷银行卡：超过5万需要账户开通储蓄卡快捷支付后再操作，单笔/单日100万、单月无限额； <br />
                                    3、实时提现银行卡：支持中信、光大、平安、招行卡通，以卡通本身额度为准。
								</div>
							</div>
						</div>
						<div class="question_item">
							<div class="q">
								<label>问：</label>
								<span>理财宝转出至银行卡支持的银行</span>
							</div>
							<div class="a">
								<label>答：</label>
								<div class="text">
									目前支持工行、招行、建行、中行、农行、交行、浦发、广发、邮储、中信、光大、兴业、民生、平安、杭州银行、宁波银行等多家银行，具体以页面展示为准。
								</div>
							</div>
						</div>
					</div>
				</div>
                </form>
			</div>
		</div>
		<div class="blank0"></div>
	</div>
	<div class="blank0"></div>
</div>
<script>
	$("#redeem_money").bind("keyup",function(event){
			code = event.keyCode;
			//if( code>=96 && code <=105 ||code == 110)
			//{
				if(parseFloat($("#redeem_money").val())>parseFloat($("#have_money").attr("title")))
				{
					$("#redeem_money").val($("#have_money").attr("title"));
					$.showErr("赎回的金额不能大于持有本金");
				}
				
				money = $("#back_rate").html() * $("#redeem_money").val();
				
				if(isNaN(money))
				{
					money = 0;
				}
				
				fun_money();
			//}
		});
	
//计算 
	var licai_type =  {$licai.type};
	var licai_interest_json = {$licai_interest_json};
	var before_rate = 0;
	var before_breach_rate = 0;
	var breach_rate = 0;
	var interest_rate = 0;

	function fun_money(){
		
			$money = $("#redeem_money");
			
			var money_val=$money.val();
			
			//$("#arrival_amount")   //预计到账金额
			//$("#arrival_earn")     //预计收益
			//$("#arrival_licai")    //预计理财收益
			
			if(licai_type > 0){
				if(licai_interest_json[licai_interest_json.length - 1]['max_money'] < money_val){
										
					before_rate = licai_interest_json[licai_interest_json.length - 1]['before_rate'];
					
					before_breach_rate = licai_interest_json[licai_interest_json.length - 1]['before_breach_rate'];
					
					breach_rate = licai_interest_json[licai_interest_json.length - 1]['breach_rate'];
					
					interest_rate = licai_interest_json[licai_interest_json.length - 1]['interest_rate'];
					
				}
				else{
					$.each(licai_interest_json,function(i,v){
						
						if( parseFloat(v['min_money']) < parseFloat(money_val) && parseFloat(v['max_money']) > parseFloat(money_val)){

							before_rate = v['before_rate'];
					
							before_breach_rate = v['before_breach_rate'];
					
							breach_rate = v['breach_rate'];
					
							interest_rate = v['interest_rate'];
						}
						
					});
				}
			}
			else{
				income_money_val = licai_interest_json;
			}
			if(money_val){
				{if $vo.licai_status == 0}
					 //预热期违约收益
					  before_arrival_earn = parseFloat($("#redeem_money").val()) * before_breach_rate / 365 / 100 * ({$vo.before_days});
					  //理财期收益
					  arrival_earn = 0;
					  $("#q_rate").html(before_breach_rate+"%");
				{elseif $vo.licai_status == 1}
					   //预热期完成收益
					  before_arrival_earn = parseFloat($("#redeem_money").val()) * before_rate / 365 / 100 * ({$vo.before_days});
					  //理财期违约收益
					  arrival_earn = parseFloat($("#redeem_money").val()) * breach_rate / 365 / 100 * ({$vo.days});
					  $("#q_rate").html(breach_rate+"%");
				{elseif $vo.licai_status == 2}
					   //预热期完成收益
					  before_arrival_earn = parseFloat($("#redeem_money").val()) * before_rate / 365 / 100 * ({$vo.before_days});
					  //理财期完成收益
					  arrival_earn = parseFloat($("#redeem_money").val()) * interest_rate / 365 / 100 * ({$vo.days});
					  $("#q_rate").html(interest_rate+"%");
				{/if}
				  //预计收益
				  arrival_amount = parseFloat($("#redeem_money").val())+ before_arrival_earn + arrival_earn;
				  
				  
				  $("#redeem_interest_money").html(arrival_earn.toFixed(2) +"元");
				  
				  $("#expect_amount").html(arrival_amount.toFixed(2));   //预计到账金额
				  $("#expect_before_earn").html(before_arrival_earn.toFixed(2));     //预计收益
				  $("#expect_earn").html(arrival_earn.toFixed(2));   //预计理财收益
			}
	}
	
	$("#redeem_btn").click(function(){
	
        var ajaxurl = '{url x="index" r="licai#uc_redeem_add" }';
		var query = new Object();
		if($("#redeem_money").val() <= 0)
		{
			$.showErr("请输入要赎回的金额");
		}
		if($("input[name=password]").val() == "")
		{
			$.showErr("请输入支付密码");
		}
		query.id = $("input[name=id]").val();
		query.redeem_money = $("#redeem_money").val();
		query.paypassword = FW_Password($("input[name=password]").val());
		
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"Post",
			dataType:"json",
			success:function(data)
			{
				if(data.status == 1){
					$.showSuccess(data.info,function(){
							location.href = location.href;	
						});
				}else if (data.status == 0){
					$.showErr(data.info,function(){
							//location.href = location.href;	
						});
				}	
			}
			,error:function()
			{
				remove();
			   	alert("errer");
			}
		});
	 });

</script>
<!--中间 结束 -->